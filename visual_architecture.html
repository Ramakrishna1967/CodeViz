<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CodeViz AI Architecture Diagrams (High Contrast)</title>
    <script src="https://cdn.jsdelivr.net/npm/mermaid@10.9.0/dist/mermaid.min.js"></script>
    <script>
        mermaid.initialize({
            startOnLoad: true,
            theme: 'base',
            themeVariables: {
                primaryColor: '#ffffff',
                primaryTextColor: '#000000',
                primaryBorderColor: '#000000',
                lineColor: '#000000',
                secondaryColor: '#ffffff',
                tertiaryColor: '#ffffff',
            },
            flowchart: { useMaxWidth: true, htmlLabels: true }
        });
    </script>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            line-height: 1.6;
            color: #000;
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
            background-color: #fff;
        }

        h1,
        h2 {
            border-bottom: 2px solid #000;
            padding-bottom: 10px;
            color: #000;
        }

        .diagram-container {
            background-color: white;
            border: 2px solid #000;
            border-radius: 4px;
            padding: 20px;
            margin-bottom: 40px;
            box-shadow: none;
            overflow-x: auto;
        }

        .description {
            margin-bottom: 15px;
            color: #333;
            font-style: italic;
            font-weight: bold;
        }
    </style>
</head>

<body>
    <h1>CodeViz AI - Advanced Architecture Maps</h1>
    <p>High-contrast visualizations of the internal logic.</p>

    <!-- Diagram 1 -->
    <h2>1. The "Big Picture" (System Architecture)</h2>
    <div class="description">This shows how the pieces fit together.</div>
    <div class="diagram-container">
        <div class="mermaid">
            graph TD
            %% Styling - Black and White
            classDef default fill:#ffffff,stroke:#000000,stroke-width:2px,color:#000000;

            User(["ðŸ‘¤ User"])

            subgraph "Frontend (Vercel)"
            UI["ðŸ’» Next.js Website"]
            end

            subgraph "Backend (Render)"
            API["ðŸ FastAPI Server"]
            Parser["âš™ï¸ Tree-Sitter Engine"]
            end

            subgraph "Cloud Services"
            Neo4j["ðŸ—„ï¸ Neo4j Graph DB"]
            Gemini["ðŸ§  Gemini 1.5 Pro"]
            GitHub["â˜ï¸ GitHub"]
            end

            User -->|1. Pastes Repo URL| UI
            UI -->|2. Sends Request| API
            API -->|3. Clones Code| GitHub
            API -->|4. Parses Code| Parser
            Parser -->|5. Saves Graph| Neo4j

            User -->|6. Asks Question| UI
            UI -->|7. Chats| API
            API -->|8. Retrieves Context| Neo4j
            API -->|9. Generates Answer| Gemini
        </div>
    </div>

    <!-- Diagram 2 -->
    <h2>2. The "Analysis" Pipeline (High Level)</h2>
    <div class="description">What happens when you click <strong>"Analyze"</strong>?</div>
    <div class="diagram-container">
        <div class="mermaid">
            sequenceDiagram
            participant U as User
            participant BE as Backend
            participant GH as GitHub
            participant TS as Parser
            participant DB as Neo4j

            Note over U, DB: Step 1: Get the Code
            U->>BE: Click "Analyze" (URL)
            BE->>GH: git clone (Download Code)
            GH-->>BE: Returns Source Files

            Note over U, DB: Step 2: Understand the Code
            loop Every File
            BE->>TS: Read File Content
            TS-->>BE: Find Functions & Classes

            BE->>DB: CREATE "File" Node
            BE->>DB: CREATE "Function" Node
            BE->>DB: CREATE "CALLS" Relationship
            end

            Note over U, DB: Step 3: Cleanup
            BE->>BE: Delete Downloaded Files
            BE-->>U: "Analysis Complete!"
        </div>
    </div>

    <!-- Diagram 3 -->
    <h2>3. Tree-Sitter Parsing Logic (AST Extraction)</h2>
    <div class="description">How raw code text is analyzed, parsed into an Abstract Syntax Tree (AST), and converted
        into structured data for the database.</div>
    <div class="diagram-container">
        <div class="mermaid">
            flowchart TD
            %% Styling - Black and White
            classDef default fill:#ffffff,stroke:#000000,stroke-width:2px,color:#000000;
            classDef process fill:#ffffff,stroke:#000000,stroke-width:2px,stroke-dasharray: 5 5;

            Start(["Start Parsing"]) --> Clone["git clone to /tmp"]
            Clone --> Walk["os.walk(repo_path)"]

            Walk --> FileCheck{"Is valid file?"}
            FileCheck -- "No/Ignored" --> Walk
            FileCheck -- "Yes" --> DetectLang["Detect Language .py, .js, .ts"]

            DetectLang --> ParserSelect{"Has Parser?"}
            ParserSelect -- "No" --> Skip["Skip File"]
            ParserSelect -- "Yes" --> Parse

            subgraph "Tree-Sitter Parsing Core"
            Parse["Parse into AST Root"]

            Parse --> Q_Func["Execute Query: function.name"]
            Q_Func --> Ext_Func["Extract: Name, Line #, Params"]

            Parse --> Q_Class["Execute Query: class.name"]
            Q_Class --> Ext_Class["Extract: Name, Line #"]

            Parse --> Q_Import["Execute Query: import.from"]
            Q_Import --> Ext_Imp["Extract: Module Name"]

            Parse --> Q_Call["Execute Query: call.name"]
            Q_Call --> Ext_Call["Extract: Callee Name"]
            end

            Ext_Func --> Neo4j["Batch Create Nodes in Neo4j"]
            Ext_Class --> Neo4j
            Neo4j --> Cleanup["Delete /tmp files"]:::process
            Cleanup --> End(["Finish"])
        </div>
    </div>

    <!-- Diagram 4 -->
    <h2>4. The RAG "Fusion" Pipeline</h2>
    <div class="description">The specific sequence of database queries and prompt engineering used to generate answer
        context for the AI.</div>
    <div class="diagram-container">
        <div class="mermaid">
            sequenceDiagram
            autonumber
            participant U as User
            participant BE as Backend (RAG)
            participant DB as Neo4j
            participant G as Gemini 2.0

            Note over U, G: Phase 1: Context Retrieval
            U->>BE: "How does auth work?"
            BE->>DB: MATCH (r:Repo)-[:HAS_FILE]->(f) RETURN f.path LIMIT 50
            DB-->>BE: List[Files]
            BE->>DB: MATCH (f)-[:CONTAINS]->(fn:Function) RETURN fn.name LIMIT 30
            DB-->>BE: List[Functions]
            BE->>DB: MATCH (f)-[:CONTAINS]->(c:Class) RETURN c.name LIMIT 20
            DB-->>BE: List[Classes]

            Note over U, G: Phase 2: Context Construction
            BE->>BE: Create System Prompt
            Note right of BE: "You are an AI Architect..."<br />+ Context:<br />- File: auth.py<br />- Function:
            login()<br />- Class: User

            Note over U, G: Phase 3: Generation & Referencing
            BE->>G: generate_content(System Prompt + User Question)
            G-->>BE: "Auth is handled in [auth.py:10-50]..."

            BE->>BE: Regex Parser (r'\[(.+):(\d+)-(\d+)\]')
            Note right of BE: Extracts references:<br />{file: "auth.py", lines: 10-50}

            BE-->>U: Final Response + Clickable References
        </div>
    </div>

    <!-- Diagram 5 -->
    <h2>5. The Neo4j Graph Schema (Entity-Relationship)</h2>
    <div class="description">The exact database schema, showing node labels, properties, and relationship types.</div>
    <div class="diagram-container">
        <div class="mermaid">
            erDiagram
            Repository ||--|{ FileNode : "HAS_FILE"
            FileNode ||--o{ FunctionNode : "CONTAINS"
            FileNode ||--o{ ClassNode : "CONTAINS"
            FileNode ||--o{ ModuleNode : "IMPORTS"

            ClassNode ||--o{ FunctionNode : "HAS_METHOD"
            FunctionNode }o--o{ FunctionNode : "CALLS"

            Repository {
            string id
            string name
            string url
            }

            FileNode {
            string path
            string language
            int size
            string hash
            }

            FunctionNode {
            string name
            int start_line
            int end_line
            string params
            string return_type
            }

            ClassNode {
            string name
            int start_line
            int end_line
            }

            ModuleNode {
            string name
            }
        </div>
    </div>

</body>

</html>